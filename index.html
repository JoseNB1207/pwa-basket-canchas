<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Canchas de Baloncesto Cercanas</title>

<!-- Manifest para PWA -->
<link rel="manifest" href="manifest.json" />
<meta name="theme-color" content="#2c3e50" />

<!-- Leaflet CSS -->
<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
/>

<style>
  body {
    font-family: Arial, sans-serif;
    margin: 0; padding: 0;
  }
  header {
    background-color: #2c3e50;
    color: white;
    padding: 1rem;
    text-align: center;
  }
  #map {
    height: 60vh;
    width: 100%;
  }
  #lista-canchas-container {
    padding: 1rem;
  }
  #lista-canchas {
    max-height: 35vh;
    overflow-y: auto;
  }
  .cancha {
    border: 1px solid #ddd;
    border-radius: 8px;
    margin-bottom: 1rem;
    padding: 1rem;
    box-shadow: 0 1px 4px rgba(0,0,0,0.1);
    cursor: default;
  }
  .calificacion {
    color: #f39c12;
    font-weight: bold;
  }
  .ambiente {
    font-style: italic;
    color: #27ae60;
  }
  .defecto {
    color: #e74c3c;
  }
  #volver-lista-btn {
    display: none;
    margin-bottom: 1rem;
    padding: 0.5rem 1rem;
    background-color: #2980b9;
    color: white;
    border: none;
    border-radius: 6px;
    cursor: pointer;
  }
  #volver-lista-btn:hover {
    background-color: #3498db;
  }
</style>
</head>
<body>

<header>
  <h1>Canchas de Baloncesto Cercanas</h1>
  <p>Descubre las mejores canchas a tu alrededor</p>
</header>

<div id="map"></div>

<div id="lista-canchas-container">
  <button id="volver-lista-btn">← Volver a la lista completa</button>
  <div id="lista-canchas"></div>
</div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
  // Icono cancha
  const canchaIcon = L.icon({
    iconUrl: 'https://cdn-icons-png.flaticon.com/256/10443/10443831.png',
    iconSize: [32, 32],
    iconAnchor: [16, 32],
    popupAnchor: [0, -32]
  });

  // Datos canchas
  const canchas = [
    {
      id: 1,
      nombre: "Cancha Central",
      lat: 40.712776,
      lng: -74.005974,
      calidad: "Alta",
      malla: true,
      defectos: [],
      calificacion: 4.7,
      ambiente: "Muy buen ambiente, jugadores frecuentes y torneos los fines de semana"
    },
    {
      id: 2,
      nombre: "Cancha La Plaza",
      lat: 40.715,
      lng: -74.002,
      calidad: "Media",
      malla: false,
      defectos: ["Huecos en el piso", "Sin pintura"],
      calificacion: 3.8,
      ambiente: "Ambiente tranquilo, ideal para práctica personal"
    },
    {
      id: 3,
      nombre: "Cancha El Bosque",
      lat: 40.709,
      lng: -74.01,
      calidad: "Baja",
      malla: true,
      defectos: ["Piso resbaladizo"],
      calificacion: 2.9,
      ambiente: "Poco ambiente, jugadores ocasionales"
    },
    {
      id: 4,
      nombre: "Cancha Olímpica",
      lat: 40.716,
      lng: -74.008,
      calidad: "Alta",
      malla: true,
      defectos: [],
      calificacion: 4.9,
      ambiente: "Ambiente excelente, equipos locales juegan a diario"
    }
  ];

  // Función para calcular distancia en km entre dos puntos lat/lng (Haversine)
  function distancia(lat1, lon1, lat2, lon2) {
    const R = 6371;
    const dLat = (lat2 - lat1) * Math.PI / 180;
    const dLon = (lon2 - lon1) * Math.PI / 180;
    const a =
      Math.sin(dLat/2) * Math.sin(dLat/2) +
      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
      Math.sin(dLon/2) * Math.sin(dLon/2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    return R * c;
  }

  let userMarker = null;
  let markersLayer = L.layerGroup().addTo(map);
  let canchasCercanas = [];

  // Mostrar lista de canchas en el contenedor
  function mostrarLista(canchasLista) {
    const listaDiv = document.getElementById('lista-canchas');
    listaDiv.innerHTML = '';

    canchasLista.forEach(cancha => {
      const canchaDiv = document.createElement('div');
      canchaDiv.className = 'cancha';
      canchaDiv.innerHTML = `
        <h3>${cancha.nombre}</h3>
        <p><strong>Distancia:</strong> ${cancha.distancia.toFixed(2)} km</p>
        <p><strong>Calidad:</strong> ${cancha.calidad}</p>
        <p><strong>Malla:</strong> ${cancha.malla ? 'Sí' : '<span class="defecto">No</span>'}</p>
        <p><strong>Defectos:</strong> ${cancha.defectos.length > 0 ? cancha.defectos.map(d => `<span class="defecto">${d}</span>`).join(', ') : 'Ninguno'}</p>
        <p><strong>Calificación:</strong> <span class="calificacion">${cancha.calificacion} ⭐</span></p>
        <p><strong>Ambiente:</strong> <span class="ambiente">${cancha.ambiente}</span></p>
      `;
      listaDiv.appendChild(canchaDiv);
    });
  }

  // Agrega marcadores al mapa para las canchas pasadas
  function agregarMarcadores(canchasLista) {
    markersLayer.clearLayers();

    canchasLista.forEach(cancha => {
      const marker = L.marker([cancha.lat, cancha.lng], {icon: canchaIcon});
      marker.bindPopup(`
        <b>${cancha.nombre}</b><br/>
        Calidad: ${cancha.calidad}<br/>
        Malla: ${cancha.malla ? 'Sí' : 'No'}<br/>
        Defectos: ${cancha.defectos.length > 0 ? cancha.defectos.join(', ') : 'Ninguno'}<br/>
        Calificación: ${cancha.calificacion} ⭐<br/>
        Ambiente: ${cancha.ambiente}
      `);
      marker.addTo(markersLayer);

      marker.on('click', () => {
        mostrarLista([cancha]);
        document.getElementById('volver-lista-btn').style.display = 'inline-block';
      });
    });
  }

  // Muestra las 5 canchas más cercanas al usuario
  function mostrarCanchasCercanas(userLatLng) {
    canchas.forEach(c => {
      c.distancia = distancia(userLatLng.lat, userLatLng.lng, c.lat, c.lng);
    });

    canchas.sort((a,b) => a.distancia - b.distancia);
    canchasCercanas = canchas.slice(0, 5);

    mostrarLista(canchasCercanas);
    agregarMarcadores(canchasCercanas);
    document.getElementById('volver-lista-btn').style.display = 'none';
  }

  // Botón volver a la lista completa
  document.getElementById('volver-lista-btn').addEventListener('click', () => {
    mostrarLista(canchasCercanas);
    agregarMarcadores(canchasCercanas);
    document.getElementById('volver-lista-btn').style.display = 'none';
  });

  // Coloca o mueve marcador del usuario
  function colocarMarcadorUsuario(lat, lng) {
    if (userMarker) {
      userMarker.setLatLng([lat, lng]);
    } else {
      userMarker = L.marker([lat, lng], {title: 'Tu ubicación'}).addTo(map).bindPopup("¡Tú estás aquí!").openPopup();
    }
  }

  // Inicialización
  const map = L.map('map').setView([40.712776, -74.005974], 14);

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap contributors'
  }).addTo(map);

  function init() {
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(
        (pos) => {
          const userLatLng = {
            lat: pos.coords.latitude,
            lng: pos.coords.longitude
          };
          map.setView([userLatLng.lat, userLatLng.lng], 15);
          colocarMarcadorUsuario(userLatLng.lat, userLatLng.lng);
          mostrarCanchasCercanas(userLatLng);
        },
        () => {
          alert("No se pudo obtener tu ubicación. Mostrando canchas por defecto.");
          const defaultLoc = {lat:40.712776, lng:-74.005974};
          map.setView([defaultLoc.lat, defaultLoc.lng], 14);
          colocarMarcadorUsuario(defaultLoc.lat, defaultLoc.lng);
          mostrarCanchasCercanas(defaultLoc);
        }
      );
    } else {
      alert("Tu navegador no soporta geolocalización. Mostrando canchas por defecto.");
      const defaultLoc = {lat:40.712776, lng:-74.005974};
      map.setView([defaultLoc.lat, defaultLoc.lng], 14);
      colocarMarcadorUsuario(defaultLoc.lat, defaultLoc.lng);
      mostrarCanchasCercanas(defaultLoc);
    }
  }

  init();
</script>

<!-- Registro Service Worker para PWA -->
<script>
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('./service-worker.js')
      .then(reg => {
        console.log('Service Worker registrado con éxito:', reg.scope);
      }).catch(err => {
        console.error('Error registrando Service Worker:', err);
      });
    });
  }
</script>

</body>
</html>
